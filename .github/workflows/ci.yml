name: CI
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - edited # Since description can change API schema referenced
  push:
    branches:
      - master
      - develop

env:
  RAZZLE_API_BASE_URL: ${{ secrets.API_BASE_URL }}

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v1
        with:
          node-version: 12.x

      - name: Yarn cache
        uses: actions/cache@v1
        id: yarn-cache
        with:
          path: node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}-${{ hashFiles('.yarnrc.yml') }}

      - name: Install dependencies
        run: yarn install --immutable
        if: steps.yarn-cache.outputs.cache-hit != 'true'

      - name: Match API PR
        uses: actions-ecosystem/action-regex-match@v2
        id: api-pr
        with:
          text: ${{ github.event.pull_request.body }}
          regex: 'API PR: https:\/\/github\.com\/SeedCompany\/cord-api-v3\/pull\/(\d+)'
        if: "contains(github.event.pull_request.body, 'API PR: https://')"

      - name: Download API Schema
        uses: dawidd6/action-download-artifact@v2
        with:
          repo: SeedCompany/cord-api-v3
          workflow: ci.yml
          name: schema.graphql
          pr: ${{ steps.api-pr.outputs.group1 }}
          path: server_build
        if: ${{ steps.api-pr.outputs.group1 != '' }}

      - name: Generate GraphQL types
        run: yarn gql-gen -e

      - name: Check TypeScript
        run: yarn type-check

      - name: Lint
        run: yarn eslint --ext .ts,.tsx --max-warnings 0 .

      - name: Build
        run: yarn razzle build

      - name: Test
        run: yarn test
